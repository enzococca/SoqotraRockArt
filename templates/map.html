{% extends "base.html" %}

{% block title %}Map View - Soqotra Rock Art Database{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-6">
        <h1><i class="bi bi-map"></i> Map View</h1>
    </div>
    <div class="col-md-6 text-end">
        <a href="{{ url_for('records') }}" class="btn btn-outline-primary">
            <i class="bi bi-list-ul"></i> Back to Records
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-0">
                <div id="map" style="height: 600px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5><i class="bi bi-info-circle"></i> Map Legend</h5>
                <p class="mb-0">
                    <i class="bi bi-geo-alt-fill text-danger"></i> Rock art site location
                    | Click on markers to view record details
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Initialize map
const map = L.map('map').setView([{{ config.DEFAULT_MAP_CENTER[0] }}, {{ config.DEFAULT_MAP_CENTER[1] }}], {{ config.DEFAULT_MAP_ZOOM }});

// Add OpenStreetMap tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxNativeZoom: 19,
    maxZoom: 25  // Consente zoom digitale fino a 1cm
}).addTo(map);

// GeoJSON data from server
const geojson = {{ geojson|tojson }};

// Custom marker icon
const customIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

// Add GeoJSON layer to map
L.geoJSON(geojson, {
    pointToLayer: function(feature, latlng) {
        return L.marker(latlng, {icon: customIcon});
    },
    onEachFeature: function(feature, layer) {
        const props = feature.properties;
        const popupContent = `
            <div class="popup-content">
                <h6><strong>${props.site} - ${props.motif}</strong></h6>
                <p class="mb-1"><strong>Type:</strong> ${props.type || '-'}</p>
                <p class="mb-2"><strong>Description:</strong> ${props.description || '-'}</p>
                <a href="/record/${props.id}" class="btn btn-sm btn-primary">View Details</a>
            </div>
        `;
        layer.bindPopup(popupContent);
    }
}).addTo(map);

// Fit map to markers if there are any
if (geojson.features.length > 0) {
    const bounds = L.geoJSON(geojson).getBounds();
    map.fitBounds(bounds, {padding: [50, 50]});
}
</script>
{% endblock %}
