{% extends "base.html" %}

{% block title %}Map View - Soqotra Rock Art{% endblock %}

{% block extra_head %}
<style>
    #map {
        height: calc(100vh - 200px);
        min-height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .map-controls {
        padding: 1rem;
        background: white;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="bi bi-map"></i> Rock Art Map - SHP042</h2>

            <div class="map-controls">
                <div id="mapInfo" class="text-muted">
                    <i class="bi bi-info-circle"></i> Loading map...
                </div>
            </div>

            <div class="position-relative">
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2">Loading orthophoto...</p>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Leaflet first -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Then load GeoTIFF libraries that depend on Leaflet -->
<script src="https://unpkg.com/geotiff@2.0.7/dist-browser/geotiff.js"></script>
<script src="https://unpkg.com/georaster@1.5.6/dist/georaster.browser.bundle.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet@3.8.0/dist/georaster-layer-for-leaflet.min.js"></script>

<!-- Initialize map after all libraries are loaded -->
<script>
    var map = L.map('map').setView([12.5, 54.0], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxNativeZoom: 19,
        maxZoom: 23  // Allow zoom up to ~1cm detail
    }).addTo(map);

    const loading = document.getElementById('loadingIndicator');
    const mapInfo = document.getElementById('mapInfo');

    // Use proxy endpoint to bypass CORS
    const cogProxyUrl = window.location.origin + '/api/cog-proxy';

    console.log('Loading COG from:', cogProxyUrl);

    // Use parseGeoraster which handles GeoTIFF metadata and affine transformations automatically
    parseGeoraster(cogProxyUrl).then(georaster => {
        console.log('Georaster parsed:', georaster);
        console.log('Bounds:', georaster.xmin, georaster.ymin, georaster.xmax, georaster.ymax);
        console.log('Size:', georaster.width, 'x', georaster.height);
        console.log('Projection:', georaster.projection);

        // Create layer with the parsed georaster
        var layer = new GeoRasterLayer({
            georaster: georaster,
            opacity: 0.8,
            resolution: 256  // Display resolution (lower = faster rendering)
        });

        layer.addTo(map);

        // Fit map to orthophoto bounds
        const bounds = [[georaster.ymin, georaster.xmin], [georaster.ymax, georaster.xmax]];
        map.fitBounds(bounds);

        mapInfo.innerHTML = '<i class="bi bi-check-circle"></i> Orthophoto loaded (' +
            georaster.width + 'x' + georaster.height + ' pixels)';
        loading.style.display = 'none';
    }).catch(err => {
        console.error('COG error:', err);
        mapInfo.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error loading orthophoto: ' + err.message;
        loading.style.display = 'none';
    });

    fetch('/api/points')
        .then(r => r.json())
        .then(geojson => {
            L.geoJSON(geojson, {
                onEachFeature: function(feature, layer) {
                    const p = feature.properties;

                    // Build images gallery HTML
                    let imagesHtml = '';
                    if (p.images && p.images.length > 0) {
                        imagesHtml = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 10px 0;">';
                        p.images.forEach(img => {
                            imagesHtml += `
                                <div style="position: relative;">
                                    <img src="${img.thumbnail_path}"
                                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer;"
                                         onclick="window.open('${img.image_path}', '_blank')">
                                    <a href="${img.download_url}"
                                       class="btn btn-sm btn-primary"
                                       style="position: absolute; bottom: 5px; right: 5px; padding: 2px 6px; font-size: 0.75rem;"
                                       title="Download">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            `;
                        });
                        imagesHtml += '</div>';
                        if (p.image_count > p.images.length) {
                            imagesHtml += `<div class="text-muted small">Showing ${p.images.length} of ${p.image_count} images</div>`;
                        }
                    }

                    layer.bindPopup(`
                        <div style="min-width: 300px; max-width: 400px;">
                            <h5 style="margin-bottom: 10px;">${p.motif}</h5>
                            <div style="margin-bottom: 8px;"><strong>Site:</strong> ${p.site}</div>
                            ${p.panel ? `<div style="margin-bottom: 8px;"><strong>Panel:</strong> ${p.panel}</div>` : ''}
                            ${p.groups ? `<div style="margin-bottom: 8px;"><strong>Groups:</strong> ${p.groups}</div>` : ''}
                            ${p.type ? `<div style="margin-bottom: 8px;"><strong>Type:</strong> ${p.type}</div>` : ''}
                            ${p.date ? `<div style="margin-bottom: 8px;"><strong>Date:</strong> ${p.date}</div>` : ''}
                            ${p.description ? `<div style="margin-bottom: 8px;"><strong>Description:</strong><br><span style="font-size: 0.9rem;">${p.description.substring(0, 200)}${p.description.length > 200 ? '...' : ''}</span></div>` : ''}
                            ${imagesHtml}
                            <div style="margin-top: 10px; text-align: center;">
                                <a href="/record/${p.id}" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="bi bi-box-arrow-up-right"></i> Full Details
                                </a>
                            </div>
                        </div>
                    `, {
                        maxWidth: 450,
                        maxHeight: 600
                    });
                }
            }).addTo(map);
        });
</script>
{% endblock %}
