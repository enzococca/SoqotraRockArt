{% extends "base.html" %}

{% block title %}Map View - Soqotra Rock Art{% endblock %}

{% block extra_head %}
<style>
    #map {
        height: calc(100vh - 200px);
        min-height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .map-controls {
        padding: 1rem;
        background: white;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="bi bi-map"></i> Rock Art Map - SHP042</h2>

            <div class="map-controls">
                <div id="mapInfo" class="text-muted">
                    <i class="bi bi-info-circle"></i> Loading map...
                </div>
            </div>

            <div class="position-relative">
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2">Loading orthophoto...</p>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Leaflet first -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Then load GeoTIFF libraries that depend on Leaflet -->
<script src="https://unpkg.com/geotiff@2.0.7/dist-browser/geotiff.js"></script>
<script src="https://unpkg.com/georaster@1.5.6/dist/georaster.browser.bundle.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet@3.8.0/dist/georaster-layer-for-leaflet.min.js"></script>

<!-- Initialize map after all libraries are loaded -->
<script>
    var map = L.map('map').setView([12.5, 54.0], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 19
    }).addTo(map);

    const loading = document.getElementById('loadingIndicator');
    const mapInfo = document.getElementById('mapInfo');

    // Use proxy endpoint to bypass CORS
    const cogProxyUrl = window.location.origin + '/api/cog-proxy';

    console.log('Loading COG from:', cogProxyUrl);

    fetch(cogProxyUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch COG: ' + response.status);
            }
            console.log('COG fetched, parsing...');
            return response.arrayBuffer();
        })
        .then(arrayBuffer => {
            console.log('COG size:', arrayBuffer.byteLength, 'bytes');
            return parseGeoraster(arrayBuffer);
        })
        .then(georaster => {
            console.log('COG loaded successfully:', georaster);
            var layer = new GeoRasterLayer({
                georaster: georaster,
                opacity: 0.8,
                resolution: 256
            });
            layer.addTo(map);
            map.fitBounds(layer.getBounds());
            mapInfo.innerHTML = '<i class="bi bi-check-circle"></i> Orthophoto loaded';
            loading.style.display = 'none';
        })
        .catch(err => {
            console.error('COG error:', err);
            mapInfo.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error loading orthophoto: ' + err.message;
            loading.style.display = 'none';
        });

    fetch('/api/points')
        .then(r => r.json())
        .then(geojson => {
            L.geoJSON(geojson, {
                onEachFeature: function(feature, layer) {
                    const p = feature.properties;
                    layer.bindPopup(`
                        <h6>${p.motif}</h6>
                        <div><strong>Site:</strong> ${p.site}</div>
                        <div><strong>Type:</strong> ${p.type || 'N/A'}</div>
                        <a href="/record/${p.id}" class="btn btn-sm btn-primary mt-2">View</a>
                    `);
                }
            }).addTo(map);
        });
</script>
{% endblock %}
